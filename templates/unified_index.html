<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markdown Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" integrity="sha512-P02it93yHqdNK0qi6ixkmKuuNH5hMgFBhbv7FLnTvF3z4r3nWxdcQN9l8QNX6h/c0e97/8lCxJ6zIS95/JoSuA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            color-scheme: dark;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        a {
            color: #58a6ff;
        }

        .app-shell {
            display: grid;
            grid-template-columns: minmax(0, 3fr) 280px;
            gap: 20px;
            padding: 24px;
            min-height: 100vh;
        }

        @media (max-width: 980px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }
        }

        .viewer {
            display: flex;
            flex-direction: column;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            min-height: 60vh;
            overflow: hidden;
        }

        .file-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            padding: 20px;
            border-bottom: 1px solid #30363d;
            background: linear-gradient(135deg, rgba(34, 45, 64, 0.9), rgba(19, 24, 32, 0.9));
        }

        .file-header h1 {
            margin: 0;
            font-size: 1.6rem;
            color: #f0f6fc;
        }

        .file-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .file-meta small {
            color: #8b949e;
        }

        .file-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-actions button {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: #238636;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, background 0.2s ease;
        }

        .file-actions button.secondary {
            background: #30363d;
            color: #c9d1d9;
        }

        .file-actions button.danger {
            background: #da3633;
        }

        .file-actions button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .file-actions button:not(:disabled):hover {
            transform: translateY(-1px);
        }

        .status-message {
            color: #ffa657;
            font-size: 0.9rem;
        }

        .content-area {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .content-area h1,
        .content-area h2,
        .content-area h3,
        .content-area h4,
        .content-area h5,
        .content-area h6 {
            color: #f0f6fc;
        }

        .content-area code {
            background: #0d1117;
            border-radius: 6px;
            padding: 2px 5px;
        }

        .content-area pre {
            background: #0d1117;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
        }

        .raw-view {
            display: none;
            margin: 0;
            padding: 20px;
            border-top: 1px solid #30363d;
            background: #0d1117;
            font-family: "SF Mono", "JetBrains Mono", monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .raw-view.visible {
            display: block;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            gap: 16px;
            max-height: calc(100vh - 48px);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.1rem;
            color: #f0f6fc;
        }

        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff7b72;
        }

        .connection-indicator.connected {
            background: #3fb950;
        }

        .file-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
        }

        .file-list li {
            margin: 0;
        }

        .file-button {
            width: 100%;
            background: #1f242e;
            border: 1px solid transparent;
            border-radius: 8px;
            color: inherit;
            padding: 10px 12px;
            text-align: left;
            cursor: pointer;
            transition: border 0.2s ease, background 0.2s ease;
        }

        .file-button:hover {
            border-color: #30363d;
        }

        .file-button.active {
            background: #238636;
            border-color: #2ea043;
        }

        .empty-state {
            color: #8b949e;
            font-size: 0.95rem;
            text-align: center;
            padding: 24px 12px;
        }

        .directory-path {
            font-size: 0.85rem;
            color: #8b949e;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <section class="viewer">
            <header class="file-header">
                <div class="file-meta">
                    <h1 id="file-name">Markdown Viewer</h1>
                    <small class="directory-path">Watching: <span id="directory-path"></span></small>
                    <span id="status-message" class="status-message"></span>
                </div>
                <div class="file-actions">
                    <button id="download-button" title="Download the current file">Download</button>
                    <button id="raw-button" class="secondary" title="Toggle raw markdown view">Show Raw</button>
                    <button id="delete-button" class="danger" title="Delete the current file">Delete</button>
                </div>
            </header>
            <div id="content" class="content-area"></div>
            <pre id="raw-view" class="raw-view"></pre>
        </section>
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Directory</h2>
                <span id="connection-indicator" class="connection-indicator" title="WebSocket status"></span>
            </div>
            <ul id="file-list" class="file-list"></ul>
        </aside>
    </div>

    <script>
        window.__INITIAL_STATE__ = __INITIAL_STATE_JSON__;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/14.1.2/marked.min.js" integrity="sha512-NHkNVzjoZWU7FZrc4KCgDtvlW+14ZduU7/r/GOr1d6dN3clcjx4zYSF/1O6B3lCm2jNyinAlkL4evdu+Td5Vew==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-WDSA6k+zHblAWd3q3RtCoX6q4me7jaFtnVnefQ4btYWhYqNe3oCzUF3pKwafKYpUBSChMkAIFbFx3v8GQAOG1A==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js" integrity="sha512-XJIOzEi9xdyD4qEfPXbI0k24AU6swswhsCce1sQsOhTIycFhGLhbVLsoP1ZaqhojaG6OcP7d3gi8wTY07EL3nw==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script defer>
        (function () {
            const state = window.__INITIAL_STATE__ || {};
            const content = document.getElementById('content');
            const rawView = document.getElementById('raw-view');
            const fileName = document.getElementById('file-name');
            const directoryPath = document.getElementById('directory-path');
            const statusMessage = document.getElementById('status-message');
            const fileList = document.getElementById('file-list');
            const downloadButton = document.getElementById('download-button');
            const rawButton = document.getElementById('raw-button');
            const deleteButton = document.getElementById('delete-button');
            const indicator = document.getElementById('connection-indicator');

            let currentFile = state.selectedFile || null;
            let files = Array.isArray(state.files) ? state.files : [];
            let websocket = null;
            let reconnectTimer = null;
            let rawVisible = false;

            const originalPathArgument = state.pathArgument || '';
            let resolvedRootPath = state.rootPath || '';

            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ startOnLoad: false, theme: 'dark' });
            }

            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    highlight(code, language) {
                        try {
                            if (typeof hljs !== 'undefined') {
                                if (language && hljs.getLanguage(language)) {
                                    return hljs.highlight(code, { language }).value;
                                }
                                return hljs.highlightAuto(code).value;
                            }
                        } catch (err) {
                            console.warn('Highlight.js failed to render a block', err);
                        }
                        return code;
                    },
                });
            }

            function setStatus(message) {
                statusMessage.textContent = message || '';
            }

            function setConnectionStatus(connected) {
                indicator.classList.toggle('connected', connected);
                indicator.title = connected ? 'Connected to watcher' : 'Disconnected';
            }

            function updateHeader() {
                fileName.textContent = currentFile || 'No file selected';
                directoryPath.textContent = resolvedRootPath || originalPathArgument || 'Unknown';
                downloadButton.disabled = !currentFile;
                rawButton.disabled = !currentFile;
                deleteButton.disabled = !currentFile;
            }

            function buildQuery(params) {
                const query = new URLSearchParams();
                if (originalPathArgument) {
                    query.set('path', originalPathArgument);
                }
                Object.entries(params).forEach(([key, value]) => {
                    if (value !== undefined && value !== null && value !== '') {
                        query.set(key, value);
                    }
                });
                const queryString = query.toString();
                return queryString ? `?${queryString}` : '';
            }

            function updateLocation(file) {
                const newQuery = buildQuery({ file });
                window.history.replaceState({ file }, '', `${window.location.pathname}${newQuery}`);
            }

            function ensureMermaidRendered() {
                if (typeof mermaid === 'undefined') {
                    return;
                }

                const codeBlocks = content.querySelectorAll('pre code.language-mermaid');
                codeBlocks.forEach((block) => {
                    const pre = block.parentElement?.parentElement;
                    if (!pre) {
                        return;
                    }
                    const diagram = document.createElement('div');
                    diagram.className = 'mermaid';
                    diagram.textContent = block.textContent;
                    pre.replaceWith(diagram);
                });

                const diagrams = content.querySelectorAll('.mermaid');
                if (diagrams.length > 0) {
                    try {
                        mermaid.run({ querySelector: '.mermaid' });
                    } catch (err) {
                        console.warn('Mermaid render failed', err);
                    }
                }
            }

            function renderMarkdown(markdownText) {
                if (typeof marked !== 'undefined') {
                    content.innerHTML = marked.parse(markdownText || '');
                } else {
                    content.textContent = markdownText || '';
                }

                if (typeof hljs !== 'undefined') {
                    content.querySelectorAll('pre code').forEach((block) => {
                        try {
                            hljs.highlightElement(block);
                        } catch (err) {
                            console.warn('Highlight.js error', err);
                        }
                    });
                }

                ensureMermaidRendered();
                rawView.textContent = markdownText || '';
            }

            function renderFileList() {
                fileList.innerHTML = '';
                if (!files.length) {
                    const empty = document.createElement('li');
                    empty.className = 'empty-state';
                    empty.textContent = 'No markdown files yet';
                    fileList.appendChild(empty);
                    return;
                }

                files.forEach((file) => {
                    const item = document.createElement('li');
                    const button = document.createElement('button');
                    button.className = 'file-button';
                    button.textContent = file.name;
                    button.dataset.file = file.relativePath;
                    if (file.relativePath === currentFile) {
                        button.classList.add('active');
                    }
                    button.addEventListener('click', () => {
                        if (file.relativePath !== currentFile) {
                            selectFile(file.relativePath);
                        }
                    });
                    item.appendChild(button);
                    fileList.appendChild(item);
                });
            }

            function updateActiveFileHighlight() {
                fileList.querySelectorAll('.file-button').forEach((button) => {
                    button.classList.toggle('active', button.dataset.file === currentFile);
                });
            }

            async function fetchJson(url, options) {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `Request failed with status ${response.status}`);
                }
                return response.json();
            }

            async function refreshFiles() {
                const url = `/api/files${buildQuery({})}`;
                const data = await fetchJson(url);
                resolvedRootPath = data.rootPath || resolvedRootPath;
                files = data.files || [];
                renderFileList();
                if (!files.find((entry) => entry.relativePath === currentFile)) {
                    currentFile = files.length ? files[0].relativePath : null;
                    if (currentFile) {
                        await loadFile(currentFile);
                    } else {
                        currentFile = null;
                        renderMarkdown(fallbackMarkdownFor(resolvedRootPath || originalPathArgument || 'the selected path'));
                        updateLocation('');
                        rawVisible = false;
                        rawView.classList.remove('visible');
                        rawButton.textContent = 'Show Raw';
                        updateHeader();
                    }
                } else {
                    updateActiveFileHighlight();
                    updateHeader();
                }
            }

            function fallbackMarkdownFor(path) {
                return `# No markdown files found\n\nThe directory \`${path}\` does not contain any markdown files yet.`;
            }

            async function loadFile(file) {
                setStatus('');
                const url = `/api/file${buildQuery({ file })}`;
                try {
                    const data = await fetchJson(url);
                    resolvedRootPath = data.rootPath || resolvedRootPath;
                    currentFile = data.file || file;
                    renderMarkdown(data.content || '');
                    updateActiveFileHighlight();
                    updateHeader();
                    updateLocation(currentFile);
                    rawVisible = false;
                    rawView.classList.remove('visible');
                    rawButton.textContent = 'Show Raw';
                } catch (err) {
                    setStatus(err.message);
                    console.error('Failed to load file', err);
                }
            }

            async function selectFile(file) {
                await loadFile(file);
            }

            function setupActions() {
                downloadButton.addEventListener('click', async () => {
                    if (!currentFile) {
                        return;
                    }
                    try {
                        const data = await fetchJson(`/api/file${buildQuery({ file: currentFile })}`);
                        const blob = new Blob([data.content || ''], { type: 'text/markdown' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = currentFile;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } catch (err) {
                        setStatus(err.message);
                        console.error('Download failed', err);
                    }
                });

                rawButton.addEventListener('click', () => {
                    if (!currentFile) {
                        return;
                    }
                    rawVisible = !rawVisible;
                    rawView.classList.toggle('visible', rawVisible);
                    rawButton.textContent = rawVisible ? 'Hide Raw' : 'Show Raw';
                });

                deleteButton.addEventListener('click', async () => {
                    if (!currentFile) {
                        return;
                    }
                    const confirmed = window.confirm(`Delete ${currentFile}?`);
                    if (!confirmed) {
                        return;
                    }
                    try {
                        await fetchJson(`/api/file${buildQuery({ file: currentFile })}`, { method: 'DELETE' });
                        setStatus('File deleted.');
                        await refreshFiles();
                    } catch (err) {
                        setStatus(err.message);
                        console.error('Delete failed', err);
                    }
                });
            }

            function connectWebSocket() {
                if (websocket) {
                    websocket.close();
                }

                const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                websocket = new WebSocket(`${protocol}://${window.location.host}/ws`);

                websocket.addEventListener('open', () => {
                    setConnectionStatus(true);
                    websocket.send(JSON.stringify({ type: 'subscribe', path: originalPathArgument }));
                });

                websocket.addEventListener('message', async (event) => {
                    try {
                        const payload = JSON.parse(event.data);
                        if (payload.type === 'directory_update') {
                            resolvedRootPath = payload.path || resolvedRootPath;
                            files = payload.files || [];
                            renderFileList();
                            if (!files.find((entry) => entry.relativePath === currentFile)) {
                                currentFile = files.length ? files[0].relativePath : null;
                                if (currentFile) {
                                    await loadFile(currentFile);
                                } else {
                                    currentFile = null;
                                    renderMarkdown(fallbackMarkdownFor(resolvedRootPath || originalPathArgument || 'the selected path'));
                                    updateLocation('');
                                    rawVisible = false;
                                    rawView.classList.remove('visible');
                                    rawButton.textContent = 'Show Raw';
                                    updateHeader();
                                }
                            } else {
                                updateActiveFileHighlight();
                                updateHeader();
                            }
                        } else if (payload.type === 'file_changed') {
                            if (payload.file && payload.file === currentFile) {
                                await loadFile(currentFile);
                            }
                        }
                    } catch (err) {
                        console.error('Failed to process websocket event', err);
                    }
                });

                function scheduleReconnect() {
                    if (reconnectTimer) {
                        return;
                    }
                    reconnectTimer = window.setTimeout(() => {
                        reconnectTimer = null;
                        connectWebSocket();
                    }, 1500);
                }

                websocket.addEventListener('close', () => {
                    setConnectionStatus(false);
                    scheduleReconnect();
                });

                websocket.addEventListener('error', () => {
                    websocket.close();
                });
            }

            function initialise() {
                const initialFallback = fallbackMarkdownFor(resolvedRootPath || originalPathArgument || 'the selected path');
                renderMarkdown(state.content || initialFallback);
                renderFileList();
                updateHeader();
                if (state.error) {
                    setStatus(state.error);
                }
                setupActions();
                connectWebSocket();
                if (!currentFile && files.length) {
                    currentFile = files[0].relativePath;
                    loadFile(currentFile);
                }
            }

            initialise();
        })();
    </script>
</body>
</html>
