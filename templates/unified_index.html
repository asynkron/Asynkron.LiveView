<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Live View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #e0e6ed;
            background-color: #0d1117;
            padding: 20px;
            font-size: smaller;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1f2a33 0%, #253548 100%);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #7d8590;
            font-size: 1.1rem;
        }

        .directory-info {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .directory-info strong {
            color: #58a6ff;
        }

        #content {
            background: #0d1117;
            padding: 0px;
            min-height: 400px;
        }

        /* Markdown styles */
        #content h1,
        #content h2,
        #content h3,
        #content h4,
        #content h5,
        #content h6 {
            color: #f0f6fc;
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        #content h1 {
            font-size: 2rem;
            border-bottom: 1px solid #21262d;
            padding-bottom: 8px;
        }

        #content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid #21262d;
            padding-bottom: 8px;
        }

        #content p {
            margin-bottom: 16px;
        }

        #content ul,
        #content ol {
            margin-bottom: 16px;
            padding-left: 32px;
        }

        #content li {
            margin-bottom: 4px;
        }

        #content blockquote {
            margin: 16px 0;
            padding: 0 16px;
            border-left: 4px solid #58a6ff;
            color: #7d8590;
        }

        #content code {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 2px 6px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 85%;
        }

        #content pre {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
        }

        #content pre code {
            background: none;
            border: none;
            padding: 0;
            font-size: 85%;
        }

        #content a {
            color: #58a6ff;
            text-decoration: none;
        }

        #content a:hover {
            text-decoration: underline;
        }

        #content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }

        #content th,
        #content td {
            border: 1px solid #30363d;
            padding: 8px 12px;
            text-align: left;
        }

        #content th {
            background: #161b22;
            font-weight: 600;
        }

        #content hr {
            border: none;
            border-top: 1px solid #30363d;
            margin: 24px 0;
        }

        /* Mermaid diagram styles */
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }

        /* Status indicator */
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
        }

        .status.connected {
            background: #1a7f37;
            color: white;
        }

        .status.disconnected {
            background: #cf222e;
            color: white;
        }

        /* Loading animation */
        .loading {
            text-align: left;
            color: #a0a5ad;
        }

        /* Code highlighting */
        .hljs {
            background: #161b22 !important;
        }

        /* File action buttons */
        .file-block {
            position: relative;
            margin-bottom: 40px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 10px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            align-items: center;
        }

        .file-name {
            flex: 1;
            color: #58a6ff;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #e0e6ed;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        .action-btn.delete {
            color: #ff7b72;
            border-color: #f85149;
        }

        .action-btn.delete:hover {
            background: #f85149;
            color: white;
            border-color: #f85149;
        }

        .action-btn.download {
            color: #79c0ff;
            border-color: #58a6ff;
        }

        .action-btn.download:hover {
            background: #58a6ff;
            color: white;
            border-color: #58a6ff;
        }

        .action-btn.sticky {
            color: #ffa657;
            border-color: #f0883e;
        }

        .action-btn.sticky:hover {
            background: #f0883e;
            color: white;
            border-color: #f0883e;
        }

        .action-btn.sticky.active {
            background: #f0883e;
            color: white;
            border-color: #f0883e;
        }

        .action-btn.expand {
            color: #8b949e;
            border-color: #30363d;
            min-width: 35px;
            justify-content: center;
        }

        .action-btn.expand:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }

        .file-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/14.1.2/marked.min.js" defer=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js" defer=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer=""></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            let ws = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            let mermaidReady = false;
            let mermaidIdCounter = 0;
            let markedConfigured = false;
            const textEncoder = new TextEncoder();
            const textDecoder = new TextDecoder();

            function waitForLibraries(maxRetries = 50, intervalMs = 100) {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const check = () => {
                        if (typeof marked !== 'undefined' && typeof mermaid !== 'undefined' && typeof hljs !== 'undefined') {
                            resolve();
                        } else if (attempts >= maxRetries) {
                            reject(new Error('Required libraries failed to load'));
                        } else {
                            attempts += 1;
                            setTimeout(check, intervalMs);
                        }
                    };
                    check();
                });
            }

            function initializeMermaid() {
                if (typeof mermaid === 'undefined') {
                    console.warn('Mermaid not available');
                    mermaidReady = false;
                    return;
                }

                try {
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'dark',
                        securityLevel: 'loose',
                        themeVariables: {
                            background: '#121a22',
                            primaryColor: '#1f2a33',
                            secondaryColor: '#253548',
                            primaryTextColor: '#e0e6ed',
                            primaryBorderColor: '#3d4f5c',
                            lineColor: '#7d8590',
                            tertiaryColor: '#161b22',
                            cScale0: '#58a6ff',
                            cScale1: '#79c0ff',
                            cScale2: '#a5f3fc'
                        }
                    });
                    mermaidReady = true;
                    console.log('Mermaid initialized successfully');
                    requestAnimationFrame(renderMermaidDiagrams);
                } catch (error) {
                    console.error('Failed to initialize Mermaid:', error);
                    mermaidReady = false;
                }
            }

            function escapeHtml(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function encodeMermaidSource(code) {
                if (!code) {
                    return '';
                }
                const bytes = textEncoder.encode(code);
                let binary = '';
                bytes.forEach(byte => {
                    binary += String.fromCharCode(byte);
                });
                return btoa(binary);
            }

            function decodeMermaidSource(encoded) {
                if (!encoded) {
                    return '';
                }
                try {
                    const bytes = Uint8Array.from(atob(encoded), char => char.charCodeAt(0));
                    return textDecoder.decode(bytes);
                } catch (error) {
                    console.warn('Failed to decode Mermaid source', error);
                    return '';
                }
            }

            function setupMarked() {
                if (typeof marked === 'undefined') {
                    console.warn('Marked not available');
                    return;
                }

                if (!markedConfigured) {
                    marked.use({
                        walkTokens(token) {
                            if (token && token.type === 'code') {
                                const langInput = typeof token.lang === 'string' ? token.lang : '';
                                const lang = langInput.toLowerCase();
                                if (lang.includes('mermaid')) {
                                    const id = `mermaid-${mermaidIdCounter++}`;
                                    const encodedSource = encodeMermaidSource(token.text || token.raw || '');
                                    const mermaidHtml = `<div class="mermaid" id="${id}" data-mermaid-source="${encodedSource}"></div>`;
                                    token.type = 'html';
                                    token.raw = mermaidHtml;
                                    token.text = mermaidHtml;
                                }
                            }
                        }
                    });

                    marked.setOptions({
                        highlight: function (code, lang) {
                            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                                try {
                                    return hljs.highlight(code, { language: lang }).value;
                                } catch (err) {
                                    console.warn('Highlight.js error:', err);
                                }
                            }
                            return code;
                        },
                        breaks: true,
                        gfm: true
                    });

                    markedConfigured = true;
                }
            }

            function renderMermaidDiagrams() {
                const mermaidElements = document.querySelectorAll('.mermaid');
                if (!mermaidElements.length) {
                    return;
                }

                if (mermaidReady && typeof mermaid !== 'undefined') {
                    mermaidElements.forEach((element) => {
                        const encoded = element.getAttribute('data-mermaid-source');
                        const sourceContent = encoded ? decodeMermaidSource(encoded) : element.textContent;
                        if (!sourceContent.trim()) {
                            return;
                        }
                        mermaid.render(`${element.id}-svg`, sourceContent)
                            .then(({ svg }) => {
                                element.innerHTML = svg;
                            })
                            .catch((error) => {
                                console.error('Mermaid rendering error:', error);
                                element.innerHTML = `<div style="color: #cf222e; border: 1px solid #cf222e; padding: 10px; border-radius: 4px;">Mermaid rendering error: ${escapeHtml(error.message)}</div>`;
                            });
                    });
                } else {
                    mermaidElements.forEach((element) => {
                        const encoded = element.getAttribute('data-mermaid-source');
                        const sourceContent = encoded ? decodeMermaidSource(encoded) : element.textContent;
                        element.innerHTML = `<div class="loading">📊 Mermaid diagram (awaiting Mermaid.js):<br><pre>${escapeHtml(sourceContent)}</pre></div>`;
                    });
                }
            }

            function updateStatus(connected) {
                const status = document.querySelector('.status') || createStatusElement();
                if (connected) {
                    status.textContent = '🟢 Connected';
                    status.className = 'status connected';
                } else {
                    status.textContent = '🔴 Disconnected';
                    status.className = 'status disconnected';
                }
            }

            function createStatusElement() {
                const status = document.createElement('div');
                status.className = 'status';
                document.body.appendChild(status);
                return status;
            }

            function connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws${window.location.search}`;

                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    console.log('WebSocket connected');
                    updateStatus(true);
                    reconnectAttempts = 0;
                    loadContent();
                };

                ws.onmessage = function (event) {
                    console.log('Received WebSocket message:', event.data);
                    const data = JSON.parse(event.data);
                    if (data.type === 'content_update') {
                        updateContent(data.content);
                    }
                };

                ws.onclose = function () {
                    console.log('WebSocket disconnected');
                    updateStatus(false);
                    attemptReconnect();
                };

                ws.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    updateStatus(false);
                };
            }

            function attemptReconnect() {
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, Math.pow(2, reconnectAttempts) * 1000);
                } else {
                    console.error('Max reconnection attempts reached');
                }
            }

            async function loadContent() {
                try {
                    const response = await fetch(`/api/content${window.location.search}`);
                    const data = await response.json();
                    
                    // Store file list globally for later use
                    window.fileList = data.fileList || [];
                    
                    updateContent(data.content);

                    // Update directory info
                    const directoryInfo = document.querySelector('.directory-info');
                    if (directoryInfo) {
                        directoryInfo.innerHTML = `<strong>📁 Directory:</strong> ${data.directory} | <strong>📄 Files:</strong> ${data.files} | <strong>🕒 Last Updated:</strong> ${new Date(data.timestamp * 1000).toLocaleString()}`;
                    }
                } catch (error) {
                    console.error('Error loading content:', error);
                    document.getElementById('content').innerHTML = '<div class="loading">❌ Error loading content</div>';
                }
            }

            function updateContent(markdownContent) {
                if (typeof marked === 'undefined') {
                    document.getElementById('content').innerHTML = '<div class="loading">⏳ Loading markdown renderer...</div>';
                    return;
                }

                try {
                    mermaidIdCounter = 0;
                    
                    // Split content by file separators (---)
                    const sections = markdownContent.split('\n\n---\n\n');
                    const contentDiv = document.getElementById('content');
                    contentDiv.innerHTML = '';
                    
                    sections.forEach((section, index) => {
                        if (!section.trim()) return;
                        
                        // Create a file block container
                        const fileBlock = document.createElement('div');
                        fileBlock.className = 'file-block';
                        
                        // Add action buttons if we have file metadata
                        if (window.fileList && window.fileList[index]) {
                            const fileInfo = window.fileList[index];
                            const actions = document.createElement('div');
                            actions.className = 'file-actions';
                            const expandBtnId = `expand-btn-${index}`;
                            const contentId = `content-${index}`;
                            const stickyClass = fileInfo.isSticky ? 'active' : '';
                            const stickyIcon = fileInfo.isSticky ? '📌' : '📍';
                            actions.innerHTML = `
                                <button class="action-btn expand" id="${expandBtnId}" onclick="toggleExpand('${contentId}', '${expandBtnId}')">
                                    ▼
                                </button>
                                <span class="file-name">📄 ${escapeHtml(fileInfo.name)}</span>
                                <button class="action-btn sticky ${stickyClass}" onclick="toggleSticky('${escapeHtml(fileInfo.fileId)}')">
                                    ${stickyIcon} Sticky
                                </button>
                                <button class="action-btn download" onclick="downloadFileAsPDF('${escapeHtml(fileInfo.fileId)}', '${escapeHtml(fileInfo.name)}')">
                                    📥 Download PDF
                                </button>
                                <button class="action-btn delete" onclick="deleteFile('${escapeHtml(fileInfo.fileId)}')">
                                    🗑️ Delete
                                </button>
                            `;
                            fileBlock.appendChild(actions);
                        }
                        
                        // Add the rendered content
                        const contentSection = document.createElement('div');
                        contentSection.className = 'file-content';
                        contentSection.id = `content-${index}`;
                        contentSection.innerHTML = marked.parse(section);
                        fileBlock.appendChild(contentSection);
                        
                        contentDiv.appendChild(fileBlock);
                    });

                    // Highlight code blocks
                    if (typeof hljs !== 'undefined') {
                        document.querySelectorAll('pre code').forEach((block) => {
                            if (block.classList.contains('language-mermaid')) {
                                return;
                            }
                            hljs.highlightElement(block);
                        });
                    }

                    renderMermaidDiagrams();
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                    document.getElementById('content').innerHTML = `<div style="color: #cf222e;">Error rendering markdown: ${error.message}</div>`;
                }
            }
            
            async function deleteFile(fileId) {
                if (!confirm(`Are you sure you want to delete "${fileId}"?`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/delete${window.location.search}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fileId: fileId })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('File deleted successfully');
                        // Reload content
                        loadContent();
                    } else {
                        alert(`Error deleting file: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error deleting file:', error);
                    alert(`Error deleting file: ${error.message}`);
                }
            }
            
            async function downloadFileAsPDF(fileId, fileName) {
                try {
                    // Get the individual file content
                    const response = await fetch(`/api/file?fileId=${encodeURIComponent(fileId)}${window.location.search.replace('?', '&')}`);
                    const result = await response.json();
                    
                    if (!result.success) {
                        alert(`Error loading file: ${result.error}`);
                        return;
                    }
                    
                    // Create a temporary window with the rendered content
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${escapeHtml(fileName)}</title>
                            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-dark.min.css">
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/14.1.2/marked.min.js"><\/script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js"><\/script>
                            <style>
                                body {
                                    background: white;
                                    padding: 40px;
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
                                }
                                .markdown-body {
                                    max-width: 800px;
                                    margin: 0 auto;
                                    color: #24292f;
                                    background: white;
                                }
                                @media print {
                                    body { padding: 20px; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="markdown-body" id="content">Loading...</div>
                            <script>
                                mermaid.initialize({ startOnLoad: false, theme: 'default' });
                                
                                // Wait for marked to load
                                function waitForMarked() {
                                    if (typeof marked !== 'undefined') {
                                        const content = ${JSON.stringify(result.content)};
                                        const html = marked.parse(content);
                                        document.getElementById('content').innerHTML = html;
                                        
                                        // Render mermaid diagrams
                                        const mermaidElements = document.querySelectorAll('.language-mermaid');
                                        let rendered = 0;
                                        if (mermaidElements.length > 0) {
                                            mermaidElements.forEach((element, i) => {
                                                const code = element.textContent;
                                                const id = 'mermaid-' + i;
                                                mermaid.render(id, code).then(({ svg }) => {
                                                    const container = document.createElement('div');
                                                    container.innerHTML = svg;
                                                    element.parentElement.replaceWith(container);
                                                    rendered++;
                                                    if (rendered === mermaidElements.length) {
                                                        setTimeout(() => window.print(), 500);
                                                    }
                                                }).catch(err => {
                                                    console.error('Mermaid error:', err);
                                                    rendered++;
                                                    if (rendered === mermaidElements.length) {
                                                        setTimeout(() => window.print(), 500);
                                                    }
                                                });
                                            });
                                        } else {
                                            setTimeout(() => window.print(), 500);
                                        }
                                    } else {
                                        setTimeout(waitForMarked, 100);
                                    }
                                }
                                waitForMarked();
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    alert(`Error downloading PDF: ${error.message}`);
                }
            }
            
            function toggleExpand(contentId, btnId) {
                const content = document.getElementById(contentId);
                const btn = document.getElementById(btnId);
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    btn.textContent = '▼';
                } else {
                    content.classList.add('collapsed');
                    btn.textContent = '▶';
                }
            }
            
            async function toggleSticky(fileId) {
                try {
                    const response = await fetch(`/api/toggle-sticky${window.location.search}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fileId: fileId })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('Sticky status toggled successfully');
                        // Reload content to reflect the change
                        loadContent();
                    } else {
                        alert(`Error toggling sticky: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error toggling sticky:', error);
                    alert(`Error toggling sticky: ${error.message}`);
                }
            }

            // Initialize everything
            waitForLibraries()
                .then(() => {
                    console.log('All libraries loaded successfully');
                    initializeMermaid();
                    setupMarked();
                    connectWebSocket();
                    loadContent();
                })
                .catch((error) => {
                    console.error('Failed to load required libraries:', error);
                    document.getElementById('content').innerHTML = '<div class="loading">❌ Failed to load required libraries</div>';
                });
        });
    </script>
</head>

<body>
    <div class="container">
        <div class="directory-info">
            <strong>📁 Directory:</strong> __CURRENT_DIRECTORY__ | <strong>📄 Files:</strong> Loading... | <strong>🕒
                Last Updated:</strong> Loading...
        </div>

        <div id="content" class="loading">
            ⏳ Loading content...
        </div>
    </div>
</body>

</html>
