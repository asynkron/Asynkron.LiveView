<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Live View</title>
    <style>
        :root {
            /* Palette extracted from Asynkron.Documentation custom theme */
            --asynkron-color-primary: #00adf8;
            --asynkron-color-danger: #c34423;
            --asynkron-color-warning: #ffbf34;
            --asynkron-color-info: #727f99;
            --asynkron-color-success: #00cc66;
            --asynkron-color-quote: #fff2cc;
            --asynkron-color-surface: #323f49;
            --asynkron-color-border: #323f49;
            --asynkron-code-surface: #2c3944;
            --asynkron-code-foreground: #f8f8f2;
            --asynkron-code-keyword: #4fc3ff;
            --asynkron-code-string: #ffd166;
            --asynkron-code-comment: #c6a6ff;
            --asynkron-code-function: #57ff8c;
            --asynkron-code-datatype: #ff6fa8;
            --asynkron-surface-dark: #0d1117;
            --asynkron-surface-darker: #161b22;
            --asynkron-surface-deep: #121a22;
            --asynkron-accent-1: #1f2a33;
            --asynkron-accent-2: #253548;
            --asynkron-accent-3: #3d4f5c;
            --asynkron-text-primary: #e0e6ed;
            --asynkron-text-muted: #7d8590;
            --asynkron-text-subtle: #a0a5ad;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--asynkron-text-primary);
            background-color: var(--asynkron-surface-dark);
            padding: 20px;
            font-size: smaller;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--asynkron-accent-1) 0%, var(--asynkron-accent-2) 100%);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--asynkron-text-muted);
            font-size: 1.1rem;
        }

        .directory-info {
            background: var(--asynkron-surface-darker);
            border: 1px solid var(--asynkron-color-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .directory-info strong {
            color: var(--asynkron-color-primary);
        }

        #content {
            background: var(--asynkron-surface-dark);
            padding: 0px;
            min-height: 400px;
        }

        /* Markdown styles */
        #content h1,
        #content h2,
        #content h3,
        #content h4,
        #content h5,
        #content h6 {
            color: #f0f6fc;
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        #content h1 {
            font-size: 2rem;
            border-bottom: 1px solid var(--asynkron-accent-3);
            padding-bottom: 8px;
        }

        #content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid var(--asynkron-accent-3);
            padding-bottom: 8px;
        }

        #content p {
            margin-bottom: 16px;
        }

        #content ul,
        #content ol {
            margin-bottom: 16px;
            padding-left: 32px;
        }

        #content li {
            margin-bottom: 4px;
        }

        #content blockquote {
            margin: 16px 0;
            padding: 0 16px;
            border-left: 4px solid var(--asynkron-color-primary);
            color: var(--asynkron-text-muted);
        }

        #content code {
            background: var(--asynkron-code-surface);
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 2px 6px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 85%;
            color: var(--asynkron-code-foreground);
        }

        #content pre {
            background: var(--asynkron-code-surface);
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
        }

        #content pre code {
            background: none;
            border: none;
            padding: 0;
            font-size: 85%;
        }

        #content a {
            color: var(--asynkron-color-primary);
            text-decoration: none;
        }

        #content a:hover {
            text-decoration: underline;
        }

        #content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }

        #content th,
        #content td {
            border: 1px solid var(--asynkron-color-border);
            padding: 8px 12px;
            text-align: left;
        }

        #content th {
            background: var(--asynkron-surface-darker);
            font-weight: 600;
        }

        #content hr {
            border: none;
            border-top: 1px solid var(--asynkron-color-border);
            margin: 24px 0;
        }

        /* Mermaid diagram styles */
        .mermaid {
            text-align: center;
            margin: 20px 0;
            display: block;
            background-color: var(--asynkron-code-surface) !important;
            border: none !important;
            border-radius: 0;
            padding: 24px;
            color: #ffffff !important;
        }

        .mermaid svg {
            height: 100% !important;
        }

        .mermaid .node.default .label-container > path:first-of-type,
        .mermaid .node.default rect,
        .mermaid .node.default circle.label-container {
            fill: var(--asynkron-color-primary) !important;
            stroke: none !important;
        }

        .mermaid .node.default .nodeLabel,
        .mermaid .node.default .nodeLabel p {
            color: #ffffff !important;
        }

        .mermaid .node.default.message .label-container > path:first-of-type,
        .mermaid .node.default.message rect,
        .mermaid .node.default.message circle.label-container {
            fill: #ffffff !important;
        }

        .mermaid .node.default.message .nodeLabel,
        .mermaid .node.default.message .nodeLabel p {
            color: #000000 !important;
        }

        .mermaid .node.default.green .label-container > path:first-of-type,
        .mermaid .node.default.green rect,
        .mermaid .node.default.green circle.label-container {
            fill: var(--asynkron-color-success) !important;
        }

        .mermaid .node.default.blue .label-container > path:first-of-type,
        .mermaid .node.default.blue rect,
        .mermaid .node.default.blue circle.label-container {
            fill: #007cb4 !important;
        }

        .mermaid .node.default.yellow .label-container > path:first-of-type,
        .mermaid .node.default.yellow rect,
        .mermaid .node.default.yellow circle.label-container {
            fill: var(--asynkron-color-warning) !important;
        }

        .mermaid .node.default.yellow .nodeLabel,
        .mermaid .node.default.yellow .nodeLabel p {
            color: #000000 !important;
        }

        .mermaid g .comment .label-container {
            fill: var(--asynkron-color-quote);
            stroke: #d6b656;
            stroke-width: 4px;
        }

        .mermaid g .comment .label {
            color: #404040;
            font-family: 'trebuchet ms', verdana, arial !important;
            font-size: 15px;
            font-weight: bold;
        }

        .mermaid g .message .label-container {
            fill: #ffffff;
            stroke: #e0e0e0;
            stroke-width: 4px;
        }

        .mermaid g .message .label {
            color: #404040;
        }

        .mermaid g .gray .label-container {
            fill: var(--asynkron-color-info);
            stroke: var(--asynkron-color-border);
            stroke-width: 3px;
        }

        .mermaid g .red .label-container {
            fill: var(--asynkron-color-danger);
            stroke: var(--asynkron-color-border);
            stroke-width: 3px;
        }

        .mermaid g .yellow .label-container {
            fill: var(--asynkron-color-warning);
            stroke: var(--asynkron-color-border);
            stroke-width: 3px;
        }

        .mermaid g .green .label-container {
            fill: var(--asynkron-color-success);
            stroke: var(--asynkron-color-border);
            stroke-width: 3px;
        }

        .mermaid g .blue .label-container {
            fill: #007cb4;
            stroke: var(--asynkron-color-border);
            stroke-width: 3px;
        }

        .mermaid g .light-blue .label-container {
            fill: var(--asynkron-color-primary);
            stroke: var(--asynkron-color-border);
            stroke-width: 3px;
        }

        .mermaid g .label-container {
            stroke: #232c34;
            stroke-width: 2px;
            fill: #007cb4;
        }

        .mermaid g .label {
            color: #ffffff;
            font-family: 'trebuchet ms', verdana, arial !important;
            font-weight: bold;
            font-size: small;
        }

        .mermaid g .actor,
        .mermaid g rect.actor,
        .mermaid g .actor > rect {
            stroke: none;
            fill: #007cb4;
        }

        .mermaid g text.actor {
            fill: #ffffff;
            stroke: none;
            font-family: 'trebuchet ms', verdana, arial !important;
            font-weight: bold;
        }

        .mermaid g .edgePath .path {
            stroke-width: 4px;
            stroke: #00ff00;
        }

        .mermaid g .edgePath marker {
            stroke: #00ff00;
            fill: #00ff00;
        }

        .mermaid g line,
        .mermaid g line.loopLine {
            stroke-width: 2px !important;
            stroke: #a0a0a0 !important;
        }

        .mermaid g .cluster rect {
            fill: #00b3f624;
            stroke: none;
        }

        .mermaid g .cluster span {
            color: #ffffff;
        }

        .mermaid g .messageText,
        .mermaid .messageText {
            fill: #ffffff !important;
            stroke: none !important;
            font-family: 'trebuchet ms', verdana, arial !important;
        }

        .mermaid g .labelBox {
            stroke: none;
            fill: #ffffff;
        }

        .mermaid g .labelText {
            fill: #000000;
            stroke: none;
            font-family: 'trebuchet ms', verdana, arial !important;
        }

        .mermaid .messageLine0,
        .mermaid g .messageLine0 {
            marker-end: url(#arrowhead) !important;
            stroke-width: 4px !important;
            stroke: #00ff00 !important;
        }

        .mermaid .messageLine1,
        .mermaid g .messageLine1 {
            stroke-width: 1.5px !important;
            stroke-dasharray: 2 2 !important;
            stroke: #00ff00 !important;
        }

        /* Status indicator */
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
        }

        .status.connected {
            background: #1a7f37;
            color: white;
        }

        .status.disconnected {
            background: #cf222e;
            color: white;
        }

        /* Loading animation */
        .loading {
            text-align: left;
            color: var(--asynkron-text-subtle);
        }

        /* Code highlighting */
        .hljs {
            background: var(--asynkron-code-surface) !important;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/14.1.2/marked.min.js" defer=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js" defer=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer=""></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            let ws = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            let mermaidReady = false;
            let mermaidIdCounter = 0;
            let markedConfigured = false;
            const textEncoder = new TextEncoder();
            const textDecoder = new TextDecoder();

            function waitForLibraries(maxRetries = 50, intervalMs = 100) {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const check = () => {
                        if (typeof marked !== 'undefined' && typeof mermaid !== 'undefined' && typeof hljs !== 'undefined') {
                            resolve();
                        } else if (attempts >= maxRetries) {
                            reject(new Error('Required libraries failed to load'));
                        } else {
                            attempts += 1;
                            setTimeout(check, intervalMs);
                        }
                    };
                    check();
                });
            }

            function initializeMermaid() {
                if (typeof mermaid === 'undefined') {
                    console.warn('Mermaid not available');
                    mermaidReady = false;
                    return;
                }

                try {
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'dark',
                        securityLevel: 'loose',
                        themeVariables: {
                            fontFamily: "'trebuchet ms', verdana, arial",
                            primaryColor: '#323f49',
                            primaryTextColor: '#ffffff',
                            primaryBorderColor: '#007cb4',
                            primaryBorderColorDark: '#007cb4',
                            secondaryColor: '#007cb4',
                            secondaryTextColor: '#ffffff',
                            actorBkg: '#007cb4',
                            actorTextColor: '#ffffff',
                            actorLineColor: '#007cb4',
                            activationBorderColor: '#000000',
                            activationBkgColor: '#ffc107',
                            lineColor: '#00ff00',
                            signalTextColor: '#ffffff',
                            signalColor: '#00ff00',
                            background: '#232c34',
                            mainBkg: '#232c34',
                            nodeBorder: '#007cb4',
                            clusterBkg: '#00b3f6',
                            noteBkgColor: '#ffbb00',
                            noteTextColor: '#373635',
                            noteBorderColor: '#ffbb00',
                            labelBoxBkgColor: '#ffffff',
                            labelBoxBorderColor: '#00ff00',
                            labelTextColor: '#000000',
                            sequenceNumberColor: '#00ff00'
                        }
                    });
                    mermaidReady = true;
                    console.log('Mermaid initialized successfully');
                    requestAnimationFrame(renderMermaidDiagrams);
                } catch (error) {
                    console.error('Failed to initialize Mermaid:', error);
                    mermaidReady = false;
                }
            }

            function escapeHtml(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function encodeMermaidSource(code) {
                if (!code) {
                    return '';
                }
                const bytes = textEncoder.encode(code);
                let binary = '';
                bytes.forEach(byte => {
                    binary += String.fromCharCode(byte);
                });
                return btoa(binary);
            }

            function decodeMermaidSource(encoded) {
                if (!encoded) {
                    return '';
                }
                try {
                    const bytes = Uint8Array.from(atob(encoded), char => char.charCodeAt(0));
                    return textDecoder.decode(bytes);
                } catch (error) {
                    console.warn('Failed to decode Mermaid source', error);
                    return '';
                }
            }

            function setupMarked() {
                if (typeof marked === 'undefined') {
                    console.warn('Marked not available');
                    return;
                }

                if (!markedConfigured) {
                    marked.use({
                        walkTokens(token) {
                            if (token && token.type === 'code') {
                                const langInput = typeof token.lang === 'string' ? token.lang : '';
                                const lang = langInput.toLowerCase();
                                if (lang.includes('mermaid')) {
                                    const id = `mermaid-${mermaidIdCounter++}`;
                                    const encodedSource = encodeMermaidSource(token.text || token.raw || '');
                                    const mermaidHtml = `<div class="mermaid" id="${id}" data-mermaid-source="${encodedSource}"></div>`;
                                    token.type = 'html';
                                    token.raw = mermaidHtml;
                                    token.text = mermaidHtml;
                                }
                            }
                        }
                    });

                    marked.setOptions({
                        highlight: function (code, lang) {
                            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                                try {
                                    return hljs.highlight(code, { language: lang }).value;
                                } catch (err) {
                                    console.warn('Highlight.js error:', err);
                                }
                            }
                            return code;
                        },
                        breaks: true,
                        gfm: true
                    });

                    markedConfigured = true;
                }
            }

            function renderMermaidDiagrams() {
                const mermaidElements = document.querySelectorAll('.mermaid');
                if (!mermaidElements.length) {
                    return;
                }

                if (mermaidReady && typeof mermaid !== 'undefined') {
                    mermaidElements.forEach((element) => {
                        const encoded = element.getAttribute('data-mermaid-source');
                        const sourceContent = encoded ? decodeMermaidSource(encoded) : element.textContent;
                        if (!sourceContent.trim()) {
                            return;
                        }
                        mermaid.render(`${element.id}-svg`, sourceContent)
                            .then(({ svg }) => {
                                element.innerHTML = svg;
                            })
                            .catch((error) => {
                                console.error('Mermaid rendering error:', error);
                                element.innerHTML = `<div style="color: #cf222e; border: 1px solid #cf222e; padding: 10px; border-radius: 4px;">Mermaid rendering error: ${escapeHtml(error.message)}</div>`;
                            });
                    });
                } else {
                    mermaidElements.forEach((element) => {
                        const encoded = element.getAttribute('data-mermaid-source');
                        const sourceContent = encoded ? decodeMermaidSource(encoded) : element.textContent;
                        element.innerHTML = `<div class="loading">üìä Mermaid diagram (awaiting Mermaid.js):<br><pre>${escapeHtml(sourceContent)}</pre></div>`;
                    });
                }
            }

            function updateStatus(connected) {
                const status = document.querySelector('.status') || createStatusElement();
                if (connected) {
                    status.textContent = 'üü¢ Connected';
                    status.className = 'status connected';
                } else {
                    status.textContent = 'üî¥ Disconnected';
                    status.className = 'status disconnected';
                }
            }

            function createStatusElement() {
                const status = document.createElement('div');
                status.className = 'status';
                document.body.appendChild(status);
                return status;
            }

            function connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws${window.location.search}`;

                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    console.log('WebSocket connected');
                    updateStatus(true);
                    reconnectAttempts = 0;
                    loadContent();
                };

                ws.onmessage = function (event) {
                    console.log('Received WebSocket message:', event.data);
                    const data = JSON.parse(event.data);
                    if (data.type === 'content_update') {
                        updateContent(data.content);
                    }
                };

                ws.onclose = function () {
                    console.log('WebSocket disconnected');
                    updateStatus(false);
                    attemptReconnect();
                };

                ws.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    updateStatus(false);
                };
            }

            function attemptReconnect() {
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, Math.pow(2, reconnectAttempts) * 1000);
                } else {
                    console.error('Max reconnection attempts reached');
                }
            }

            async function loadContent() {
                try {
                    const response = await fetch(`/api/content${window.location.search}`);
                    const data = await response.json();
                    updateContent(data.content);

                    // Update directory info
                    const directoryInfo = document.querySelector('.directory-info');
                    if (directoryInfo) {
                        directoryInfo.innerHTML = `<strong>üìÅ Directory:</strong> ${data.directory} | <strong>üìÑ Files:</strong> ${data.files} | <strong>üïí Last Updated:</strong> ${new Date(data.timestamp * 1000).toLocaleString()}`;
                    }
                } catch (error) {
                    console.error('Error loading content:', error);
                    document.getElementById('content').innerHTML = '<div class="loading">‚ùå Error loading content</div>';
                }
            }

            function updateContent(markdownContent) {
                if (typeof marked === 'undefined') {
                    document.getElementById('content').innerHTML = '<div class="loading">‚è≥ Loading markdown renderer...</div>';
                    return;
                }

                try {
                    mermaidIdCounter = 0;
                    const html = marked.parse(markdownContent);
                    document.getElementById('content').innerHTML = html;

                    // Highlight code blocks
                    if (typeof hljs !== 'undefined') {
                        document.querySelectorAll('pre code').forEach((block) => {
                            if (block.classList.contains('language-mermaid')) {
                                return;
                            }
                            hljs.highlightElement(block);
                        });
                    }

                    renderMermaidDiagrams();
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                    document.getElementById('content').innerHTML = `<div style="color: #cf222e;">Error rendering markdown: ${error.message}</div>`;
                }
            }

            // Initialize everything
            waitForLibraries()
                .then(() => {
                    console.log('All libraries loaded successfully');
                    initializeMermaid();
                    setupMarked();
                    connectWebSocket();
                    loadContent();
                })
                .catch((error) => {
                    console.error('Failed to load required libraries:', error);
                    document.getElementById('content').innerHTML = '<div class="loading">‚ùå Failed to load required libraries</div>';
                });
        });
    </script>
</head>

<body>
    <div class="container">
        <div class="directory-info">
            <strong>üìÅ Directory:</strong> __CURRENT_DIRECTORY__ | <strong>üìÑ Files:</strong> Loading... | <strong>üïí
                Last Updated:</strong> Loading...
        </div>

        <div id="content" class="loading">
            ‚è≥ Loading content...
        </div>
    </div>
</body>

</html>
