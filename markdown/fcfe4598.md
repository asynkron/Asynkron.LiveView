# 📋 Feature 1302443 Planning Summary
## Spectre Event Receiver - REST API Gateway for Guidewire Webhooks

---

## 🎯 Overview
**Central Event Ingestion Point** for Guidewire (ifwire) webhooks - simplifying administration, improving performance, and enabling rapid development.

**Status:** Active | **Priority:** 2 | **Iteration:** 25.3 Supersprint  
**Assigned:** Roger Johansson | **Designer:** Sebastian Nilsson

---

## 💼 Business Value

### Key Benefits
1. **🔧 Admin Simplification** - Single endpoint vs. multiple per message type × environment
2. **⚡ Performance** - Resolves current webhook performance issues in Guidewire
3. **🚀 Rapid Development** - Add Spectre functionality without Guidewire changes
4. **🎯 Centralization** - Single scalable entry point
5. **🔮 Future-Proof** - Easy integration of new event sources
6. **🛡️ Reliability** - Deduplication and validation prevent errors

---

## 🏗️ Architecture Highlights

### Technology Stack
- **Application:** ASP.NET Web API
- **Message Queue:** Azure Service Bus (FIFO)
- **Storage:** Azure Storage Account (with retention)
- **API Gateway:** Azure API Management
- **IaC:** Terraform
- **Authentication:** OAuth 2.0

### Key Design Decisions
✅ New repository (future Spectre monorepo)  
✅ Separate endpoint per Guidewire xCenter  
✅ Clear code separation per message type  
✅ FIFO queue maintains Guidewire order  
✅ Message compression using .NET standard  

---

## 📝 Core Requirements

### 1️⃣ API Functionality
- ✅ Accept webhooks from Guidewire
- ✅ Separate endpoints per xCenter
- ✅ Return 202 for valid, 4xx for invalid
- ✅ Guidewire handles retries

### 2️⃣ Validation & Deduplication
- ✅ Reject duplicate event IDs
- ✅ Only predefined event types accepted
- ✅ Schema validation

### 3️⃣ Security
- ✅ OAuth authentication enforced
- ✅ Encryption at rest (Azure Service Bus)
- ✅ Full message traceability with retention
- ✅ No PII/sensitive data in logs (GDPR)

### 4️⃣ Performance
- ✅ Meet Spectre SLOs (uptime, response time, error rate)
- ✅ HTTP header-based early filtering
- ✅ Lazy JSON body reading
- ✅ Message compression/decompression

### 5️⃣ Error Handling
- ✅ Invalid messages rejected
- ✅ Clear error responses
- ✅ Comprehensive error logging

---

## 🔨 Implementation Tasks

### Workitem 1324374 - IaC Config (5 pts)
**Owner:** Tommy Ekh | **Status:** New | **Iteration:** 25.3.1

**Deliverables:**
- Terraform templates for all Azure resources
- CI/CD pipeline for Terraform
- Network and security configuration
- Validated in dev environment

**⚠️ Blocker:** Need agreement on naming conventions (Tommy's comment)

---

### Workitem 1324394 - ASP.NET Application (5 pts)
**Owner:** Unassigned | **Status:** New | **Iteration:** 25.3 Supersprint

**Deliverables:**
- New Azure DevOps repository
- ASP.NET application with full functionality
- Deployment pipeline
- Deployed to dev environment

---

### Workitem 1324416 - PAP and APIM (3 pts)
**Owner:** Unassigned | **Status:** New | **Iteration:** 25.3.1

**Deliverables:**
- PAP process initiated
- Non-production APIM registration
- Guidewire integration ready

---

## 🔗 Parent Context

### Epic 1220953 - Issue Car Insurance Policy
This feature enables the broader goal of allowing **Car Dealers to sell Car Insurance policies**.

**Epic Success Criteria:**
- Car Dealers can convert quotes to policies
- Payment methods supported
- Legal documents delivered
- Direct debit integration
- MTPL certificate registration
- Commission tracking
- GL integration

---

## ⚠️ Out of Scope

❌ No transactionality or command handling  
❌ No message processing/transformation (ingestion only)  
❌ No consumer implementation  
❌ No additional compliance integration  

---

## 🎪 Message Flow

```
Guidewire Webhook
    ↓
OAuth Validation
    ↓
HTTP Header Check (early filter)
    ↓
JSON Body Parse (lazy)
    ↓
Validation (type, schema, dedup)
    ↓
Store (traceability with retention)
    ↓
Compress
    ↓
Azure Service Bus Topic (FIFO)
    ↓
HTTP 202 Response
```

---

## 📊 Architecture Components

### Infrastructure (Terraform)
- **App Service** - Hosts ASP.NET API
- **App Service Plan** - Compute resources
- **Service Bus** - Message queuing with topics
- **Storage Account** - Message traceability
- **Network** - Security groups, firewall
- **APIM** - API gateway, OAuth, rate limiting

### Application Structure
```
/EventReceiverApi        # Web API
/EventTypes              # Per-event handlers
  /PolicyCreated
  /PolicyUpdated
  /ClaimCreated
/Validation              # Validation logic
/Storage                 # Message storage
/ServiceBus              # Queue integration
/Authentication          # OAuth handling
```

---

## ❓ Open Questions

1. **Naming conventions** - Need agreement (blocks IaC)
2. **Event type catalog** - Complete list of supported events?
3. **Retention period** - How long to keep stored messages?
4. **Throughput targets** - Messages/second requirement?
5. **Azure SKU** - Which App Service tier?
6. **Compression** - GZip or Brotli?
7. **OAuth provider** - Configuration details?
8. **Service Bus** - Topic vs Queue, partitioning?

---

## 🚦 Next Steps

### Immediate (This Week)
1. ✅ Requirements documented
2. ⏭️ **Resolve naming conventions** (Tommy)
3. ⏭️ **Finalize Azure SKUs** (Tommy)
4. ⏭️ **Create repository** (Developer)
5. ⏭️ **Start Terraform** (Tommy)
6. ⏭️ **Initiate PAP** (Developer)

### Development Sequence
1. Infrastructure (IaC) 
2. Application scaffold
3. Core API implementation
4. APIM integration
5. Testing & validation
6. Documentation

---

## 📚 References

### Documentation
- [Feature Design (Confluence)](https://confluence.ifint.biz/spaces/MNC/pages/375593997/Feature+1302443)
- [ADR-015: Event Receiver Architecture](https://confluence.ifint.biz/spaces/MNC/pages/364143842/CTP-ADR-015+Event+receiver+architecture+in+Spectre)
- [Spectre ADR-015 Details](https://confluence.ifint.biz/spaces/MNC/pages/371852928/Spectre+Details+for+ADR-015)
- [Epic 1220953 Documentation](https://confluence.ifint.biz/spaces/MNC/pages/342700499/Epic+1220953+-+Issue+Car+Insurance+policy)

### Workitems
- [Feature 1302443](https://dev.azure.com/if-it/mobility-CTP/_workitems/edit/1302443) - Main Feature
- [Epic 1220953](https://dev.azure.com/if-it/mobility-CTP/_workitems/edit/1220953) - Parent Epic
- [Story 1324374](https://dev.azure.com/if-it/mobility-CTP/_workitems/edit/1324374) - IaC Config
- [Story 1324394](https://dev.azure.com/if-it/mobility-CTP/_workitems/edit/1324394) - ASP.NET App
- [Story 1324416](https://dev.azure.com/if-it/mobility-CTP/_workitems/edit/1324416) - PAP/APIM

---

## ✅ Success Criteria

### Technical
- ✅ All acceptance criteria met
- ✅ All child workitems completed
- ✅ Deployed and validated in dev
- ✅ APIM registered
- ✅ Performance SLOs met
- ✅ Security requirements satisfied

### Business
- ✅ Admin overhead reduced
- ✅ Performance improved
- ✅ Ready for rapid development
- ✅ Supports policy issuance workflow

---

**Planning Status:** ✅ Complete - Ready for Implementation  
**Full Requirements:** See `requirements.md` in repository
